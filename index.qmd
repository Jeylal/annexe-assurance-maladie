---
title: "L'assurance-maladie obligatoire suisse dans l'impasse. Une analyse du compromis socio-politique derrière la Loi fédérale sur l’assurance-maladie (LAMal)"
affiliations:
  - id: unige
    name: "Université de Genève"
author:
  - name: "Celâl Güney"
    orcid: "0009-0008-2601-030X"
    corresponding: true
    email: "celal.gueney@unige.ch"
    affiliations: [unige]
    roles: ["Doctorant"]
  - name: "Gaia Valenti"
    affiliations: [unige]
    roles: ["Doctorante"]
date: last-modified
bibliography: references.bib
number-sections: true
---

# Annexe

## Stratégie empirique pour les modèles de la section 4

La spécification des modèles présentés dans la section 4 a pour objectif de reproduire une analyse néoréaliste des facteurs influençant les attentes sociales. Les variables dépendantes sont binarisées afin de conduire des estimations de modèles logistiques binaires en utilisant l’estimation du maximum de vraisemblance. La variable d’opinion sur l’augmentation de la franchise minimale de l’assurance-maladie de base est construite sur une échelle Likert de 1 (fortement contre) à 5 (fortement pour). Nous avons créé une variable dichotomique pour les deux premières catégories (fortement contre et contre). Pour le choix du vote pour l’initiative d’allègement des primes, nous avons dichotomisé en binarisant le vote en faveur de l’initiative. Les principales variables explicatives que nous avons considérées sont un indice de classe sociale mesurée par la classification européenne des groupes socioéconomiques (ESEG), le revenu mensuel brut du ménage, à partir duquel nous calculons le niveau de revenu par décile, ainsi qu’une batterie d’indicateurs socio-démographiques (âge, langue, cantons, genre) et idéologiques (auto-positionnement gauche-droite, vote, probabilité de vote pour les principaux partis politiques, opinions sur des sujets économiques et identitaires). Pour chacune de nos deux variables dépendantes, nous avons procédé à une sélection de modèle pas à pas descendante avec le critère d’information d’Akaike (AIC). Cette procédure a abouti au modèle suivant pour l’opposition à l’augmentation de la franchise minimale:

$$
P(y_i = 1) = logit^{-1}(\beta_0 + \beta_{d}D_i + \beta X_i + \gamma_p P_i + \eta_o O_i + \epsilon_i) 
$$ {#eq-1}

Avec $P(y_i = 1)$ la probabilité de l’individu $i$ d’être contre l’augmentation de la franchise minimale, $D_i$ le niveau de décile auquel appartient l’individu $i$, $X_i$ un vecteur de caractéristiques individuelles socio-démographique (âge, genre, langue), $P_i$ un vecteur de variable sur la probabilité de voter pour certains partis politiques suisses (Le Centre, le Parti Socialiste, les Verts et les Verts Libéraux) sur une échelle de 0 à 10, et $O_i$ l’opinion sur une série d’enjeux comme l’intégration européenne, le salaire minimum ou encore les dépenses sociales. $\epsilon_i$ est le terme d’erreur. De manière surprenante, la variable pour les groupes socio-économiques ESEG n’a pas été retenue par la procédure de sélection, ce qui implique que la classe sociale telle que mesurée par l’indice ESEG ne semble pas jouer un rôle déterminant par rapport au niveau de revenu et aux autres variables de contrôle Comme le schéma de classe ESEG est une variable importante pour notre analyse, nous considérons quand même les résultats d’une régression simple de nos deux variables dépendantes sur les catégories socio-professionnelles ESEG (résultats disponibles dans l’annexe). Encore plus étonnant, la variable contrôlant pour les cantons n’a pas non plus été retenue, ce qui suggère que l’effet d’appartenance à un canton est négligeable. Le coefficient de corrélation interclasse (ICC) calculé à partir d’un modèle multiniveau avec les cantons en tant que niveau confirme que les variations entre cantons sont faibles (voir annexe). Le modèle pour le vote en faveur de l’initiative pour l’allègement des primes prend une forme similaire à (1), avec quelques différences au niveau des variables retenues car certaines d’entre elles n’étaient pas disponible dans la quatrième vague. Comme pour le premier modèle, le schéma de classe ESEG n’a pas été retenu par la procédure de sélection, ni le canton de résidence.

```{r}
#| message: false
#| warning: false
#| label: tbl-votations
#| tbl-cap: "Votations en lien avec le système de santé en Suisse. Source: Swissvotes"

library(tidyverse)
library(gt)
library(modelsummary)
library(readxl)

swissvotes <- read_delim("data/swissvotes.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(d1e3 = col_double()), 
    trim_ws = TRUE)


swissvotes %>% 
  filter(d1e3 %in% c("10.24", "10.11")) %>% 
  dplyr::select(datum, titel_kurz_f, annahme, `volkja-proz`) %>% 
  rename(
    Date = "datum",
    Votation = "titel_kurz_f",
    `Résultat` = "annahme",
    `% Oui` = "volkja-proz"
  ) %>% 
  gt()



```

## Matériel supplémentaire

```{r}
#| echo: false
#| message: false
#| warning: false


library(haven)
library(tidyverse)
library(marginaleffects)
library(sjlabelled)
library(DIGCLASS)

selects2023panel <- haven::read_sav("data/selects2023panel/selects2023panel.sav") #linux

selects2023panel$isco08 = selects2023panel$W1_ISCO08prof_2dig*100

selects2023panel2 = selects2023panel %>% 
  rename(
    "assurance_maladie_franchise_pour" = W1_f15340f,
    "op_limit_immigration" = W1_f15340b,
    "op_funding_childcare" = W1_f15340c,
    "op_protec_env" = W1_f15340d,
    'op_state_interv' = W1_f15435,
    'op_social_expenses' = W1_f15420,
    'op_eu_integration' = W1_f15425,
    'op_chances_foreigners' = W1_f15440,
    'op_gender_equality' = W1_f15475,
    'op_taxes_high_income' = W1_f15480,
    'op_traditions' = W1_f15485,
    'op_min_wage' = W1_f15815,
    'op_incr_retirementAge' = W1_f15811,
    'probs_vote_plr' = W1_f14400a,
    'probs_vote_centre' = W1_f14400j,
    'probs_vote_ps' = W1_f14400c,
    'probs_vote_udc' = W1_f14400d,
    'probs_vote_verts' = W1_f14400e,
    'probs_vote_vertsliberaux' = W1_f14400f,

  ) %>% 
  mutate(
    income = case_when(
  W1_f28910 == 1  ~ (0+2000)/2,
  W1_f28910 == 2  ~ (2001+3000)/2,
  W1_f28910 == 3  ~ (3001+4000)/2,
  W1_f28910 == 4  ~ (4001+5000)/2,
  W1_f28910 == 5  ~ (5001+6000)/2,
  W1_f28910 == 6  ~ (6001+7000)/2,
  W1_f28910 == 7  ~ (7001+8000)/2,
  W1_f28910 == 8  ~ (8001+9000)/2,
  W1_f28910 == 9  ~ (9001+10000)/2,
  W1_f28910 == 10 ~ (10001+11000)/2,
  W1_f28910 == 11 ~ (11001+12000)/2,
  W1_f28910 == 12 ~ (12001+13000)/2,
  W1_f28910 == 13 ~ (13001+14000)/2,
  W1_f28910 == 14 ~ (14001+15000)/2,
  W1_f28910 == 15 ~ (15001+16000)/2,
  W1_f28910 == 16 ~ (16001+17000)/2,
  W1_f28910 == 17 ~ (17001+18000)/2,
  W1_f28910 == 18 ~ (18001+19000)/2,
  W1_f28910 == 19 ~ (19001+20000)/2,
  W1_f28910 == 20 ~ 20001         
),
income_decile = ntile(income, n = 10),
income_adjusted = income/sqrt(W1_hhsize_sample),
income_adj_decile = ntile(income_adjusted, n = 10),

lr = if_else(W1_f15200 == 98 | is.na(W1_f15200), NA, W1_f15200),

education_ISCED = case_when(
  W1_f21310rec %in% c(1, 2) ~ 1,  # No education, Primary = ISCED 1
  W1_f21310rec == 3        ~ 2,  # Secondary school = ISCED 2
  W1_f21310rec %in% c(4,5) ~ 3,  # Basic vocational, apprenticeship = ISCED 3
  W1_f21310rec %in% c(6,7,8) ~ 4, # Upper secondary specialized, trade, vocational = ISCED 4 
  W1_f21310rec == 9 ~ 5,  # Matu = ISCED 5
  W1_f21310rec == 10 ~ 5,  # Higher vocational education with federal diploma = ISCED 5
  W1_f21310rec == 11 ~ 6,  # College of higher education = ISCED 6
  W1_f21310rec == 12 ~ 6,  # Uni of applied sciences = ISCED 6 (Bachelor level)
  W1_f21310rec == 13 ~ 7,  # University / Federal Institute of Technology = ISCED 7 (Master)
  W1_f21310rec == 14 ~ NA   # other
),

public_sector = if_else(W1_f21700 == 2, 1,
                        if_else(is.na(W1_f21700), 0, 0)),
canton = as_character(W1_canton_sample),
langue = relevel(factor(as_character(W1_munilang_sample)), ref = "German"),
gender = factor(as_label(W1_sex)),

#isco08_4d = isco08_swap(W1_ISCO08prof_2dig, from = 2, to = 3),

main_activity = case_when(
  
  W1_f21400 %in% c(1, 2, 7) ~ 1, # working
  W1_f21400 %in% c(3) ~ 2, # in training/education
  W1_f21400 %in% c(6) ~ 3, # disability
  W1_f21400 %in% c(4, 8) ~ 4, # no paid work
  W1_f21400 %in% c(5) ~ 5 # retired
  
),

work_status = case_when(
  W1_f21500 == 4 ~ 1, # self-employed
  W1_f21500 %in% c(1, 2, 3) ~ 0, # employee
  is.na(W1_f21500) ~ 2 # not employed
),

eseg = isco08_to_eseg(isco08, work_status = work_status, main_activity = main_activity, age = W1_age, to_factor = FALSE, type = "two-digit", label = FALSE)

)

#selects2023panel2$assurance_maladie_franchise_pour = selects2023panel2$assurance_maladie_franchise_pour %>% 
 # as.ordered()


selects2023panel2 = selects2023panel2 %>% 
  mutate(
     eseg9 = case_when(
       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ "Managers",
       eseg %in% c(2.1, 2.2, 2.3, 2.4, 2.5) ~ "Professionals",
       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ "Technicians and associated professionals employees",
       eseg %in% c(4.1, 4.2, 4.3) ~ "small entrepreneurs",
       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ "Clerks and skilled service employees",
       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ "Skilled industrial employees",
       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ "Lower status employees",
       eseg %in% c(8.8) ~ "Retired",
       eseg %in% c(9.1) ~ "Student",
       eseg %in% c(9.2, 9.3) ~ "Unemployed or disabled"
     ),
     
     eseg10 = case_when(
       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ "Managers",
       eseg %in% c(2.1, 2.2, 2.4, 2.5) ~ "Professionals",
       eseg == 2.3 ~ "Business and administration professionals",
       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ "Technicians and associated professionals employees",
       eseg %in% c(4.1, 4.2, 4.3) ~ "small entrepreneurs",
       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ "Clerks and skilled service employees",
       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ "Skilled industrial employees",
       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ "Lower status employees",
       eseg %in% c(8.8) ~ "Retired",
       eseg %in% c(9.1) ~ "Student",
       eseg %in% c(9.2, 9.3) ~ "Unemployed or disabled"
     ),
     
     contre_augm_franch_min = if_else(assurance_maladie_franchise_pour %in% c(1, 2), 1,
                                      if_else(is.na(assurance_maladie_franchise_pour), NA, 0))
  )

#selects2023panel2 %>% 
#  group_by(eseg10) %>% 
#  count(assurance_maladie_franchise_pour %in% c(1, 2)) %>% 
#  mutate(prop = n/sum(n)) %>% 
#  ungroup() %>% 
#  filter(`assurance_maladie_franchise_pour %in% c(1, 2)` == TRUE) %>% 
#  ggplot(aes(x = prop, y = eseg10))+
#  geom_point()
```

```{r model 1 fit}
#| echo: false
#| message: false
#| warning: false

library(MASS)
library(marginaleffects)
selects2023panel2$eseg10 = relevel(factor(selects2023panel2$eseg10), ref = "Business and administration professionals")


data_model_fit = selects2023panel2 %>% 
   dplyr::select(contre_augm_franch_min, eseg10, lr, income_adj_decile, education_ISCED, op_limit_immigration, op_funding_childcare, op_protec_env, op_state_interv, op_social_expenses, op_eu_integration, op_chances_foreigners, op_gender_equality, op_taxes_high_income, op_traditions, op_min_wage, op_incr_retirementAge, probs_vote_plr, probs_vote_centre, probs_vote_ps, probs_vote_udc, probs_vote_verts, probs_vote_vertsliberaux, canton, langue, W1_age, gender) %>% 
  drop_na()

model1 <- glm(data = data_model_fit,
           contre_augm_franch_min ~ eseg10 + lr + income_adj_decile + education_ISCED + op_limit_immigration + op_funding_childcare + op_protec_env + op_state_interv + op_social_expenses + op_eu_integration + op_chances_foreigners + op_gender_equality + op_taxes_high_income + op_traditions + op_min_wage + op_incr_retirementAge + probs_vote_plr + probs_vote_centre + probs_vote_ps + probs_vote_udc + probs_vote_verts + probs_vote_vertsliberaux + canton + langue + W1_age + gender, family = binomial(link = "logit"))

#model1_step = stepAIC(model1)

model1_step2 = glm(formula = contre_augm_franch_min ~ income_adj_decile + op_limit_immigration + 
    op_protec_env + op_social_expenses + op_eu_integration + 
    op_chances_foreigners + op_gender_equality + op_taxes_high_income + 
    op_min_wage + op_incr_retirementAge + probs_vote_centre + 
    probs_vote_ps + probs_vote_verts + probs_vote_vertsliberaux + 
    langue + W1_age + gender, family = binomial(link = "logit"), 
    data = data_model_fit)

library(performance)
model1_performance <- model_performance(model1_step2)

```

```{r selects panel for wave 4 setup}
library(haven)
library(tidyverse)
library(marginaleffects)
library(sjlabelled)
library(DIGCLASS)


# function to recode party satisfaction variables to put "don't know" as middle value

recode_party_satisfaction = function(var){
  new_var = case_when(
    var == 1 ~ 1,
    var == 2 ~ 2, 
    var == 8 ~ 3, 
    var == 3 ~ 4,
    var == 4 ~ 5
  )
}


selects2023panelW4 <-  read_sav("data/selects2023panelW4/data/2626_Selects2023_Panel_Data_v2.0.sav")

selects2023panelW4$isco08 = selects2023panelW4$W1_4_f21601_2dig*100

selects2023panelW4_2 = selects2023panelW4  %>% 
  rename(
    vote_choice = "W4_f10851main6",
    feelings_udc = 'W4_f14177a',
    feelings_ps = 'W4_f14177b',
    feelings_centre = 'W4_f14177c',
    feelings_plr = 'W4_f14177d',
    feelings_verts = 'W4_f14177e',
    feelings_vertslib = 'W4_f14177f',
    
    op_gender_equality = 'W4_f15475',
    op_state_intervention = 'W4_f15435', # 5 = for more competition
    op_2many_worries_abt_env_vs_prices = 'W4_f15478',
    op_min_wage = 'W4_f15815', # 4 = strongly in favor
    op_incr_retirement_age = 'W4_f15811',
    op_foreigners_votingrights = 'W4_f15816',
    op_rights_samesex_couples = 'W4_f15817'
    
    
    
  ) %>% 
  mutate(
    income = case_when(
  W4_f28910 == 1  ~ (0+2000)/2,
  W4_f28910 == 2  ~ (2001+3000)/2,
  W4_f28910 == 3  ~ (3001+4000)/2,
  W4_f28910 == 4  ~ (4001+5000)/2,
  W4_f28910 == 5  ~ (5001+6000)/2,
  W4_f28910 == 6  ~ (6001+7000)/2,
  W4_f28910 == 7  ~ (7001+8000)/2,
  W4_f28910 == 8  ~ (8001+9000)/2,
  W4_f28910 == 9  ~ (9001+10000)/2,
  W4_f28910 == 10 ~ (10001+11000)/2,
  W4_f28910 == 11 ~ (11001+12000)/2,
  W4_f28910 == 12 ~ (12001+13000)/2,
  W4_f28910 == 13 ~ (13001+14000)/2,
  W4_f28910 == 14 ~ (14001+15000)/2,
  W4_f28910 == 15 ~ (15001+16000)/2,
  W4_f28910 == 16 ~ (16001+17000)/2,
  W4_f28910 == 17 ~ (17001+18000)/2,
  W4_f28910 == 18 ~ (18001+19000)/2,
  W4_f28910 == 19 ~ (19001+20000)/2,
  W4_f28910 == 20 ~ 20001         
),

language = factor(as_label(W4_langint)),
gender = factor(as_label(W4_sex)),

rec_satisf_plr = recode_party_satisfaction(W4_f13743a),
rec_satisf_centre = recode_party_satisfaction(W4_f13743b),
rec_satisf_ps = recode_party_satisfaction(W4_f13743c),
rec_satisf_udc = recode_party_satisfaction(W4_f13743d),
rec_satisf_verts = recode_party_satisfaction(W4_f13743e),

income_decile = ntile(income, n = 10),
income_adjusted = income/sqrt(W4_f20500), # W4_f20500 = household size, including R
income_adj_decile = ntile(income_adjusted, n = 10),

lr = if_else(W4_f15200 == 98 | is.na(W4_f15200), NA, W4_f15200),

education_ISCED = case_when(
  W4_f21310rec %in% c(1, 2) ~ 1,  # No education, Primary = ISCED 1
  W4_f21310rec == 3        ~ 2,  # Secondary school = ISCED 2
  W4_f21310rec %in% c(4,5) ~ 3,  # Basic vocational training, apprenticeship = ISC4D 3
  W4_f21310rec %in% c(6,7,8) ~ 4, # Upper secondary specialized, tra4e, vocational = ISCED 4 
  W4_f21310rec == 9 ~ 5,  # Matu = ISCED 5
  W4_f21310rec == 10 ~ 5,  # Higher vocational education with federal dip4oma = ISCED 5
  W4_f21310rec == 11 ~ 6,  # College of higher education = ISCED 6
  W4_f21310rec == 12 ~ 6,  # Uni of applied sciences = ISCED 6 (Ba4helor level)
  W4_f21310rec == 13 ~ 7,  # University / Federal Institute of Tec4nology = ISCED 7 (Master)
  W4_f21310rec == 14 ~ NA   # other
),

public_sector = if_else(W1_4_f21700 == 2, 1, 0),
canton = as_character(W4_canton_sample),
langue = relevel(factor(as_character(W4_langint)), ref = "German"),

#isco08_4d = isco08_swap(W1_ISCO08prof_2dig, from = 2, to = 3),

main_activity = case_when(
  
  # comme il s'agit de la 4eme vague, la question si la situation de travail a changé doit etre prise en compte, si W4_f21300 == 0, la situation n'a pas changé depuis vague 1 (W1)
  W4_f21300 == 0 & W1_f21400 %in% c(1, 2, 7) ~ 1, # working
  W4_f21300 == 0 & W1_f21400 %in% c(3) ~ 2, # in training/education
  W4_f21300 == 0 & W1_f21400 %in% c(6) ~ 3, # disability
  W4_f21300 == 0 & W1_f21400 %in% c(4, 8) ~ 4, # no paid work
  W4_f21300 == 0 & W1_f21400 %in% c(5) ~ 5, # retired
  
  W4_f21300 == 1 & W4_f21400 %in% c(1, 2, 7) ~ 1, # working
  W4_f21300 == 1 & W4_f21400 %in% c(3) ~ 2, # in training/education
  W4_f21300 == 1 & W4_f21400 %in% c(6) ~ 3, # disability
  W4_f21300 == 1 & W4_f21400 %in% c(4, 8) ~ 4, # no paid work
  W4_f21300 == 1 & W4_f21400 %in% c(5) ~ 5 # retired
  
),

# Prise en compte du changement depuis W1, comme pour main_activity
work_status = case_when(
  W4_f21300 == 0 & W1_f21500 == 4 ~ 1, # self-employed
  W4_f21300 == 0 & W1_f21500 %in% c(1, 2, 3) ~ 0, # employee
  W4_f21300 == 0 & is.na(W1_f21500) ~ 2, # not employed
  
  W4_f21300 == 1 & W4_f21500 == 4 ~ 1, # self-employed
  W4_f21300 == 1 & W4_f21500 %in% c(1, 2, 3) ~ 0, # employee
  W4_f21300 == 1 & is.na(W4_f21500) ~ 2 # not employed
),


main_activity2 = case_when(
  
  W1_4_f21400 %in% c(1, 2, 7) ~ 1, # working
  W1_4_f21400 %in% c(3) ~ 2, # in training/education
  W1_4_f21400 %in% c(6) ~ 3, # disability
  W1_4_f21400 %in% c(4, 8) ~ 4, # no paid work
  W1_4_f21400 %in% c(5) ~ 5 # retired
  
),

work_status2 = case_when(
  W1_4_f21500 == 4 ~ 1, # self-employed
  W1_4_f21500 %in% c(1, 2, 3) ~ 0, # employee
  is.na(W1_4_f21500) ~ 2 # not employed
),


eseg = isco08_to_eseg(isco08, work_status = work_status2, main_activity = main_activity2, age = W4_age, to_factor = FALSE, type = "two-digit", label = FALSE),

yes_premium_initiative = if_else(W4_f10771a == 1, 1,
                                 if_else(is.na(W4_f10771a), NA, 0)),

yes_biodiversity_initiative =  if_else(W4_f10751a == 1, 1,
                                 if_else(is.na(W4_f10751a), NA, 0)),

yes_pension_reform = if_else(W4_f10751b == 1, 1,
                                 if_else(is.na(W4_f10751b), NA, 0)),

yes_13th_pension_payment = if_else(W4_f10791 == 1, 1,
                                 if_else(is.na(W4_f10791), NA, 0)),

  
)


selects2023panelW4_2 = selects2023panelW4_2 %>% 
  mutate(
     eseg9 = case_when(
       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ "Managers",
       eseg %in% c(2.1, 2.2, 2.3, 2.4, 2.5) ~ "Professionals",
       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ "Technicians and associated professionals employees",
       eseg %in% c(4.1, 4.2, 4.3) ~ "small entrepreneurs",
       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ "Clerks and skilled service employees",
       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ "Skilled industrial employees",
       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ "Lower status employees",
       eseg %in% c(8.8) ~ "Retired",
       eseg %in% c(9.1) ~ "Student",
       eseg %in% c(9.2, 9.3) ~ "Unemployed or disabled"
     ),
     
     eseg10 = case_when(
       eseg %in% c(1.1, 1.2, 1.3, 1.4) ~ "Managers",
       eseg %in% c(2.1, 2.2, 2.4, 2.5) ~ "Professionals",
       eseg == 2.3 ~ "Business and administration professionals",
       eseg %in% c(3.1, 3.2, 3.3, 3.4, 3.5) ~ "Technicians and associated professionals employees",
       eseg %in% c(4.1, 4.2, 4.3) ~ "small entrepreneurs",
       eseg %in% c(5.1, 5.2, 5.3, 5.4) ~ "Clerks and skilled service employees",
       eseg %in% c(6.1, 6.2, 6.3, 6.4, 6.5) ~ "Skilled industrial employees",
       eseg %in% c(7.1, 7.2, 7.3, 7.4) ~ "Lower status employees",
       eseg %in% c(8.8) ~ "Retired",
       eseg %in% c(9.1) ~ "Student",
       eseg %in% c(9.2, 9.3) ~ "Unemployed or disabled"
     )
  )

selects2023panelW4_2$eseg9 = relevel(as.factor(selects2023panelW4_2$eseg9), ref = "Managers")
selects2023panelW4_2$eseg10 = relevel(as.factor(selects2023panelW4_2$eseg10), ref = "Business and administration professionals")

# Schema de classe oesch

# W4_f21300: Has R's professional situation changed in the past 12 months (e.g. new job, retirement, unemployment)

# W1_4_f21500: R's current position at work, W1 updated with W4


# W4_f21400: R's current working situation, if change in professional situation

# W4_f21500: R's current position at work, if change in professional situation

# W4_f21550: Number of persons employed at company, including R, if change in professional situation

# W4_f21550_W1self: Asked to self-employed from W1 if no change in professional situation: number of persons employed at company, including R

selects2023panelW4_2 <- selects2023panelW4_2 %>% 
  mutate(
    
    self_employed = case_when(
      W1_4_f21500 == 4 ~ 1, # self employed
      W1_4_f21500 %in% c(1, 2, 3) ~ 0 # employee
    ),
    
    n_employees = case_when(
      W4_f21300 == 0 ~ W4_f21550_W1self,
      W4_f21300 == 1 ~ W4_f21550
    ),
    
    oesch8 = isco08_to_oesch(W1_4_f21601_2dig*100, self_employed = self_employed, n_employees = n_employees, n_classes = 8, to_factor = T, label = T)
    
  )

selects2023panelW4_2$vote_choice = factor(as_label(selects2023panelW4_2$vote_choice))


```

```{r premium initiative analysis}
library(lme4)
library(marginaleffects)
library(tidyverse)

data_model_fit2 = selects2023panelW4_2 %>% 
  dplyr::select(yes_premium_initiative, eseg10, income_adj_decile, education_ISCED, lr, op_state_intervention, op_2many_worries_abt_env_vs_prices, op_min_wage, op_incr_retirement_age, op_foreigners_votingrights, vote_choice, gender, W4_age, language, canton) %>% 
  drop_na()





model_glm1 = glm(data = data_model_fit2,
                 yes_premium_initiative ~ income_adj_decile + education_ISCED + eseg10 + lr + op_state_intervention + op_2many_worries_abt_env_vs_prices + op_min_wage + op_incr_retirement_age + op_foreigners_votingrights + vote_choice + gender + W4_age + language + canton,
                  family = binomial(link = "logit"))

#best_model_glm1 = stepAIC(model_glm1)

best_model_glm2 = glm(formula = yes_premium_initiative ~ income_adj_decile + I(eseg10 == "Retired") + lr + op_state_intervention + op_2many_worries_abt_env_vs_prices + op_min_wage + op_incr_retirement_age + op_foreigners_votingrights + vote_choice + gender + W4_age + language, family = binomial(link = "logit"), 
                      data = data_model_fit2)

avg_slopes_tbl_bestmodelW4 = best_model_glm2 %>% 
  avg_slopes() %>% 
  drop_na()

```

```{r}
#| message: false
#| warning: false
#| label: tbl-skim1
#| tbl-cap: "Statistiques descriptive variables du premier modèle"

library(gtsummary)
library(sjlabelled)
library(modelsummary)

selects2023panel2$assurance_maladie_franchise_pour <- labelled(selects2023panel2$assurance_maladie_franchise_pour, labels = c("Fortement contre" = 1, "Contre" = 2, "Ni pour, ni contre" = 3, "Pour" = 4, "Fortement pour" = 5))

selects2023panel2 %>% 
   dplyr::select(assurance_maladie_franchise_pour, eseg10, lr, education_ISCED, langue, W1_age, gender) %>% 
  rename(opinion_augmentation_franchise = "assurance_maladie_franchise_pour") %>% 
  mutate(across(starts_with("op"), as_label)) %>% 
  mutate(across(starts_with("opinion_augmentation_franchise"), as_label)) %>% 
  datasummary_skim(output = "html")

```

```{r}
#| label: fig-likert1
#| fig-cap: "Statistiques descriptives des variables à échelle Likert du premier modèle"

library(ggstats)


selects2023panel2 %>% 
  select(op_limit_immigration, op_funding_childcare , op_protec_env, op_min_wage, op_incr_retirementAge) %>% 
  gglikert_stacked()

```

```{r}
#| label: fig-likert2
#| fig-cap: "Statistiques descriptives des variables à échelle Likert du premier modèle (2)"

selects2023panel2 %>% 
select(op_state_interv, op_social_expenses, op_eu_integration, op_chances_foreigners, op_gender_equality, op_taxes_high_income, op_traditions) %>% 
 gglikert_stacked()+
 theme(text = element_text(size = 5))

```

```{r}
#| label: fig-likert3
#| fig-cap: "Statistiques descriptives des variables à échelle Likert du premier modèle (3)"

selects2023panel2 %>% 
  select(probs_vote_plr, probs_vote_centre, probs_vote_ps, probs_vote_udc, probs_vote_verts, probs_vote_vertsliberaux) %>% 
  gglikert_stacked()


```



```{r}

#| label: tbl-descriptivemodel2
#| tbl-cap: "Statistiques descriptives: Panel Selects 2025 vague 4 (variables du deuxième modèle)"
#| message: false
#| warning: false

selects2023panelW4_2 %>% 
  dplyr::select(yes_premium_initiative, eseg10, education_ISCED, lr, vote_choice, gender, W4_age, language, W4_f10771a) %>% 
  mutate(across(starts_with("W4_f10771a"), as_label)) %>% 
  datasummary_skim(output = "html")


```

```{r}
#| label: fig-likert4
#| fig-cap: "Statistiques descriptives des variables à échelle Likert du deuxième modèle (3)"

likertW4 <- 
selects2023panelW4_2 %>% 
  select(op_state_intervention, op_2many_worries_abt_env_vs_prices, op_min_wage, op_incr_retirement_age, op_foreigners_votingrights) %>% gglikert_stacked()+
  theme(text = element_text(size = 6))

likertW4
```


```{r tables reg logit}
#| tbl-cap: "Régressions logit (log(odd))"
#| label: tbl-reglogit

library(modelsummary)
modelsummary(list("Augmentation franchise minimale" = model1_step2), stars = T)
```


```{r}
modelsummary(list("Initiative pour l'allègement des primes" = best_model_glm2), stars = T)
```


```{r glmer canton}


library(sjPlot)
library(lme4)
library(gt)
library(gtsummary)
library(modelsummary)


glmer_canton_franchise = glmer(data = selects2023panel2,
                               contre_augm_franch_min ~ 1 + (1|canton),
                               family = binomial(link = "logit"))

glmer_canton_primes = glmer(data = selects2023panelW4_2,
                               yes_premium_initiative ~ 1 + (1|canton),
                            family = binomial(link = "logit"))


```

```{r}
#| label: tbl-canton
#| tbl-cap: "Modèle multiniveau: cantons suisses en niveau" 


modelsummary(models = list("Augmentation franchise minimale" = glmer_canton_primes, "Initiative pour l'allègement des primes" = glmer_canton_franchise))
```


```{r}
#| tbl-cap: "Régressions logistiques simples: opposition à l'augmentation de la franchise et vote pour l'allègement des primes sur les catégories socio-professionnelles ESEG (Log(Odd))"
#| label: tbl-reg2

glm_eseg_franchise = glm(data = selects2023panel2,
                               contre_augm_franch_min ~ eseg10,
                               family = binomial(link = "logit"))

glm_eseg_primes = glm(data = selects2023panelW4_2,
                               yes_premium_initiative ~ eseg10,
                            family = binomial(link = "logit"))

modelsummary(list("Augmentation franchise minimale" = glm_eseg_franchise, "Initiative pour l'allègement des primes" = glm_eseg_primes), stars = T)
```


```{r}

#| label: fig-check1
#| fig-cap: "Vérification des hypothèses du modèle logit: augmentation de la franchise minimale"
library(performance)
library(ggplotify)

checkmodel1 <- 
check_model(model1_step2)
checkmodel1

plot = plot(checkmodel1)
#ggsave("diagnosticfranchise.png", plot, width = 15, height = 10)
```

```{r}

#| label: fig-check2
#| fig-cap: "Vérification des hypothèse du modèle logit: initiative pour l'allègement des primes"

checkmodel2 <- 
check_model(best_model_glm2)

plot = plot(checkmodel2)
#ggsave("diagnosticprimes.png", plot, width = 15, height = 10)
```
